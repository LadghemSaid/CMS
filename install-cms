#!/bin/bash

# Use it :
# ./install-cms ./my-folder

# Bash script relative lines
: ${1?failure: in wich folder should i work ?}
folder=$1
echo "Installation running in folder $folder"

# First clean the folder where we will install
rm -rf ${folder}
composer clear-cache

# Install symfony
composer create-project symfony/skeleton ${folder}
cd ${folder}

# Install Pied Web CMS
composer require piedweb/cms-bundle

# Work around because we prepend our config in the bundle
#sed -i -e "/access_control:/d" ./config/packages/security.yaml
sed -i -e "/PiedWeb\\\CMSBundle\\\PiedWebCMSBundle::class => \['all' => true\],/d" config/bundles.php
sed -i -e "s/return \[/return \[\n    PiedWeb\\\CMSBundle\\\PiedWebCMSBundle::class => \['all' => true\],/" config/bundles.php
# We erase all configuration files generated by recipes and copy ours
cp -R vendor/piedweb/cms-bundle/src/Resources/config/packages/. config/packages/
php bin/console cache:clear

# Create default Entity
mkdir src/Entity
cp -R vendor/piedweb/cms-bundle/Install/Entity/. src/Entity

# Install web server to test
composer require symfony/web-server-bundle --dev

# Copy assets
mkdir -p assets
cp vendor/piedweb/cms-bundle/assets/.babelrc .babelrc
cp vendor/piedweb/cms-bundle/assets/package.json package.json
cp vendor/piedweb/cms-bundle/assets/webpack.config.js webpack.config.js
cp vendor/piedweb/cms-bundle/assets/main.js assets/main.js

# Install assets for the default theme
yarn
yarn encore dev

# Install sqlite by default
sed -i -e "s/mysql:\/\/db_user:db_password@127\.0\.0\.1:3306\/db_name/\"sqlite:\/\/\/%kernel\.project_dir%\/var\/app\.db\"/" .env

cp -f vendor/piedweb/cms-bundle/src/Resources/config/routes/all.yaml config/routes.yaml


# Create Database:
php bin/console doctrine:schema:create

# Add an admin user :
php bin/console fos:user:create admin@example.tld admin@example.tld p@ssword
php bin/console fos:user:promote admin@example.tld ROLE_SUPER_ADMIN

# Set in french :)
sed -i -e "s/locale: 'en'/locale: 'fr'/" config/services.yaml

# Install Sonata Front-End Assets
php bin/console assets:install

# Launch Server and Play
php bin/console server:run
